# ksz2

How to run the DR6 pipeline

# Generate ILC alms

- Run harmonic ILC on data k-space coadds, and noisy simulations (by combining ACT DR6 signal+noise sims and Planck noise sims). The noisy ACT simulations, generated by Frank, have the file format `kcoadd_v4_f${freq}_lmax7000_alm_set${set}_${seed}_split_${split}.fits`. These are CMB+noise only i.e. no foregrounds. Use the script `run_ilc.py` with arguments:
```
outdir="/pscratch/sd/m/maccrann/cmb/act_dr6/"
config="cldata_smooth-301-2_v4_lmax6000_60skmask_31102025"
srun -u -l -n 16  python run_ilc.py ${outdir}/ilc_${config} -c ilc_configs/${config}.yml
```
This generates ILC alms, and corresponding noisy simulations in the directory `/pscratch/sd/m/maccrann/cmb/act_dr6/ilc_cldata_smooth-301-2_v4_lmax6000_60skmask_31102025` in this case. 

As explained below however, we didn't actually use these exact simulations in the pipeline...

# Simulations 
We used a fairly confusing range of simulations for the DR6 paper in the end, definitely worth considering if we could simplify this.

1. For RDN0 and mean-field, we used noisy simulations with foreground power tuned to the data. In addition to the noisy simulations output by `run_ilc.py` above, we also Gaussian signal-only simulations with
power spectrum tuned to the data were run:
```
outdir="/pscratch/sd/m/maccrann/cmb/act_dr6/"
config="cldata_smooth-301-2_v4_lmax6000_60skmask_31102025"
srun -u -l -n 16 python sims/generate_gaussian_sims.py ${outdir}/ilc_${config}/gaussian_sims --data_template_path ${outdir}/ilc_${config}/\${freq}_split\${split}.fits --freqs hilc hilc-tsza
ndcibd hilc-tszd  --mpi --nsim 200 --mask_file ${outdir}/ilc_${config}/mask.fits --lmax 6000
```
This outputs Gaussian signal-only simulations. At the time, we had not saved noise-only simulations (only noise+CMB), so the script `sims/replace_signal.py` goes through subtracting the CMB signal, and replacing it with the Gaussian signal generated above. A bit mad, I know:
```
`srun -n 16 python replace_signal.py`
```
This outputs simulations in `/pscratch/sd/m/maccrann/cmb/act_dr6/ilc_cldata_smooth-301-2_v4_lmax6000_60skmask_31102025/data_signal_sims/`.
These are the simulations used for RDN0 and mean-field calculations. 

2. We're not quite done yet unfortunately. For transfer function (aka MC bias) and covariance calculations, we used a different set of simulations where we add kSZ signal to the noisy simulations output by `run_ilc.py`. This kSZ signal is the Alvarez 2016 kSZ signal, randomly rotated for each simulation realisation. These are generated via the script `sim_e2e_test/add_ksz_signal_ilc.sh`.

# Running the pipeline

1. Run the measurement with bias corrections

2. Run the "end-to-end" simulations
`sim_e2e_test/run_e2e_sim.sh`
